### 1 概述

##### 1.1 linux层次

三层： 最底层是硬件 硬件之上是内核 内核是操作系统核心  内核是运行在内存中的软件  

内核向中央处理器发送指令 内核管理硬件系统  是硬件系统和应用程序之间进行通信的接口  

进程是指计算机中运行的所有程序 进程由内核统一管理 进程组成最顶层 称为用户空间  


用户进程  


linux内核： 系统调用  进程管理  内存管理  设备驱动程序

硬件： cpu  内存  硬盘  网络端口  


内核和用户进程之间最主要的区别： 内核在内核模式 Kernel mode中运行  用户进程则在用户模式 user mode中运行  

内核模式中运行的代码可以不受限的访问cpu和内存 功能强大  非常危险  那些只有内核可以访问的空间称为内核空间 kernel space  

内核的内存管理  

内核将内存划分为很多区块 并且一直维护这些区块的状态信息  

内核负责管理四个方面：

* 进程 内核决定那个进程可以使用cpu

* 内存 内核管理所有内存 为进程分配内存 管理进程间的共享内存以及空闲内存

* 设备驱动程序 作为硬件系统与进程之间的接口 内存负责操控硬件设备

* 系统调用和支持 进程通常使用系统调用和内核进行通信


进程管理  

管理涉及到：进程的启动  暂停  恢复和终止  

一个进程让出CPU使用权给另一个进程称为上下文切换 context switch  

系统是在同时运行多个进程称之为多任务执行

内核负责上下文切换  其工作原理如下：

1. cpu为每一个进程及时 到时即停止进程 并切换至内内核模式---由内核接管CPU控制权  

2. 内核记录当前cpu和内存的状态信息 这些信息在恢复被停止的进程时需要用到

3. 内核执行上一个时间段内的任务

4. 内核准备执行下一个进程  从准备就绪的进程中选择一个执行  

5. 内核将新进程准备cpu和内存  

6. 内核将新进程执行的时间段通知cpu

7. 内核将cpu切换至用户模式 将cpu控制权移交给新进程  

内核是在什么时候运行的？ 内核在上下文切换时的时间段间隙中运行的  


内存管理  

内核在上下文切换过程中管理内存  

内核要保证以下所有条件：  

* 内核需要自己的专有内存空间 其他用户进程无法访问  

* 每个用户进程有自己的专有内存空间  

* 一个进程不能访问另一个进程的专有内存空间

* 用户进程之间可以共享内存  

* 用户进程的某些内存空间可以是只读的

* 通过使用磁盘交换 系统可以使用比实际内存容量更多的内存空间

Memory Management Unit 内存管理单元 MMU
MMU使用了一种叫作虚拟内存的内存访问机制  即进程不是直接访问内存的实际物理地址  而是通过内核使得进程看起来可以使用整个系统的内存  
即进程访问内存的时候 MMU截获访问请求 然后通过内存映射表将要访问的内存地址转换为实际的物理地址  

内核需要初始化 维护和更新这个地址映射表。例如在上下文切换时 内核将内存映射表从被移出进程转给被移入进程使用  

设备驱动程序和设备管理  

1. 通常设备只能在内核模式中被访问 因为设备访问不当有可能会让系统崩溃  
2. 不同设备之间没有一个统一编程接口 设备驱动程序会尽可能为用户进程提供统一的接口  以简化开发人员的工作  

系统调用和系统支持  

系统调用 system call或syscall 为进程执行一些它们不擅长或无法完成的工作  例如 打开  读取  写文件  

fork 当进程调用fork()时 内核创建一个和该进程几乎一模一样的副本  

exec 当进程调用exec(program)时 内核启动program来替换当前的进程  

Linux中的所有的用户进程都是通过fork()来启动的 除了创建现有进程的副本外  大多数情况下你还可以使用exec()来启动新进程  

通过ls命令说明：

通过终端输入ls时 终端窗口中的shell调用fork()创一个shell的副本  
然后这个shell副本 调用exec(ls)来运行ls   

虚拟设备  

虚拟设备对于用户进程而言是物理设备 但是通过软件来实现的 因此从技术角度来说  它们并不需要存在于内核中 但是实际上它们很多都存在于内核中。  


用户空间  

内核分配给用户进程的内存空间 称为用户空间 userland 

一个进程就是内存中的一个状态 用户空间也可以指所有用户进程占用的所有内存  

用户  


